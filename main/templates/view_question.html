{% extends 'base.html' %}

{% block content %}
<!-- Animate.css -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.min.css"/>

<style>
    body { background: linear-gradient(to right, #eef2f3, #dfe9f3); }
    .question-container { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
    .question-card { border-radius: 15px; background: #ffffff; padding: 25px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
    .sidebar { position: sticky; top: 20px; display: flex; flex-direction: column; gap: 20px; }
    .file-preview { background: #f9f9f9; border-radius: 10px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .comment-box { background: #fdfdfd; border-radius: 10px; border-left: 5px solid #0d6efd; padding: 15px; margin-bottom: 15px; box-shadow: 0 3px 8px rgba(0,0,0,0.05); }
    .btn-custom { border-radius: 25px; transition: 0.2s; }
    .btn-custom:hover { transform: translateY(-2px); }
    @media (max-width: 992px) { .question-container { grid-template-columns: 1fr; } .sidebar { position: static; } }
</style>

<div class="container mt-4">
    <div class="question-container animate__animated animate__fadeIn">

        <!-- Main Question Content -->
        <div class="question-card">
            <h2 class="fw-bold text-primary">{{ question.title }}</h2>
            <p class="text-muted small mb-3">
                <i class="bi bi-person-circle"></i> <strong>{{ question.user.username }}</strong> 
                &nbsp;|&nbsp; <i class="bi bi-clock"></i> {{ question.created_at|date:"F j, Y, g:i a" }}
            </p>
            <hr>
            <p class="fs-5 lh-lg">{{ question.body }}</p>

            <!-- Comments Section -->
            <hr>
            <h4 class="mb-3"><i class="bi bi-chat-dots-fill"></i> Comments</h4>
            {% for comment in comments %}
                <div class="comment-box">
                    <strong>{{ comment.author.username }}</strong> 
                    <small class="text-muted">• {{ comment.created_at|date:"F j, Y, g:i a" }}</small>

                    {% if comment.file %}
                        <div class="mt-2">
                            {% if comment.file.url|lower|slice:"-4:" == ".pdf" %}
                                <iframe src="{{ comment.file.url }}" width="100%" height="200px" style="border:none; border-radius:8px;"></iframe>
                            {% elif comment.file.url|lower|slice:"-4:" == ".png" or comment.file.url|lower|slice:"-4:" == ".jpg" or comment.file.url|lower|slice:"-5:" == ".jpeg" %}
                                <img src="{{ comment.file.url }}" class="img-fluid rounded shadow-sm" style="max-height: 200px; object-fit: contain;">
                            {% endif %}
                            <a href="{{ comment.file.url }}" target="_blank" class="btn btn-sm btn-info btn-custom mt-2">
                                <i class="bi bi-file-earmark-arrow-down"></i> View / Download File
                            </a>
                        </div>
                    {% endif %}

                    <p class="mt-2">{{ comment.content }}</p>

                    {% if request.user == comment.author or request.user.is_superuser %}
                        <div class="mt-2 d-flex gap-2 flex-wrap">
                            <a href="{% url 'edit_comment' comment.id %}" class="btn btn-sm btn-warning btn-custom">
                                <i class="bi bi-pencil"></i> Edit
                            </a>
                            <a href="{% url 'delete_comment' comment.id %}" 
                               class="btn btn-sm btn-danger btn-custom"
                               onclick="return confirm('Delete this comment?');">
                                <i class="bi bi-trash"></i> Delete
                            </a>
                        </div>
                    {% endif %}
                </div>
            {% empty %}
                <p class="text-muted fst-italic">No comments yet. Be the first one to share your thoughts!</p>
            {% endfor %}

            <!-- AI Suggestion -->
            {% if user.is_authenticated %}
            <div class="p-3 bg-light border rounded mb-3">
                <h6 class="fw-bold text-secondary"><i class="bi bi-robot"></i> AI Suggestion</h6>
                <div id="ai-box" class="small text-muted">Click below to get AI suggestion</div>
                <div class="d-flex gap-2 mt-2">
                    <button id="btn-ai" type="button" class="btn btn-outline-primary btn-sm btn-custom">Get AI Answer</button>
                    <button id="btn-ai-paste" type="button" class="btn btn-outline-success btn-sm btn-custom" disabled>Paste into Comment</button>
                </div>
            </div>
            {% endif %}

            <!-- Add Comment Form -->
            <hr>
            <h5 class="mt-3"><i class="bi bi-pencil-square"></i> Leave a Comment</h5>
            <form method="POST" enctype="multipart/form-data" class="mt-3">
                {% csrf_token %}
                {{ form.as_p }}
                <button type="submit" class="btn btn-success w-100 py-2 mt-2 btn-custom">
                    <i class="bi bi-send-fill"></i> Post Comment
                </button>
            </form>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            {% if question.file %}
            <div class="file-preview">
                <h6 class="fw-bold mb-3"><i class="bi bi-paperclip"></i> Attached File</h6>
                {% if question.file.url|lower|slice:"-4:" == ".pdf" %}
                    <iframe src="{{ question.file.url }}" width="100%" height="250px" style="border:none; border-radius:8px;"></iframe>
                    <a href="{{ question.file.url }}" target="_blank" class="btn btn-outline-success w-100 mt-2 btn-custom">
                        <i class="bi bi-eye"></i> View / Download File
                    </a>
                {% elif question.file.url|lower|slice:"-4:" == ".png" or question.file.url|lower|slice:"-4:" == ".jpg" or question.file.url|lower|slice:"-5:" == ".jpeg" %}
                    <img src="{{ question.file.url }}" class="img-fluid rounded shadow-sm" style="max-height: 200px; object-fit: contain;">
                    <a href="{{ question.file.url }}" target="_blank" class="btn btn-outline-success w-100 mt-2 btn-custom">
                        <i class="bi bi-eye"></i> View / Download File
                    </a>
                {% else %}
                    <a href="{{ question.file.url }}" target="_blank" class="btn btn-outline-success w-100 mt-2 btn-custom">
                        <i class="bi bi-eye"></i> View / Download File
                    </a>
                {% endif %}
            </div>
            {% endif %}

            {% if request.user == question.user or request.user.is_superuser %}
            <div class="p-3 bg-white border rounded shadow-sm">
                <h6 class="fw-bold text-secondary mb-3"><i class="bi bi-gear"></i> Manage Post</h6>
                <div class="d-grid gap-2">
                    <a href="{% url 'edit_question' question.id %}" class="btn btn-warning btn-custom">
                        <i class="bi bi-pencil"></i> Edit
                    </a>
                    <a href="{% url 'delete_question' question.id %}" 
                       class="btn btn-danger btn-custom"
                       onclick="return confirm('Are you sure you want to delete this post?');">
                       <i class="bi bi-trash"></i> Delete
                    </a>
                </div>
            </div>
            {% endif %}
        </div>

    </div>
</div>

<script>
(function(){
  const aiBox = document.getElementById('ai-box');
  const btn = document.getElementById('btn-ai');
  const pasteBtn = document.getElementById('btn-ai-paste');
  if(!btn || !aiBox) return;
  let lastAIText = "";
  btn.addEventListener('click', async () => {
    aiBox.textContent = "Thinking…";
    btn.disabled = true;
    pasteBtn.disabled = true;
    try {
      const res = await fetch("{% url 'ai_suggest' question.id %}");
      const data = await res.json();
      lastAIText = data.ai || "";
      aiBox.innerHTML = "<pre style='white-space:pre-wrap;'>" + lastAIText.replace(/</g,"&lt;") + "</pre>";
      pasteBtn.disabled = !lastAIText;
    } catch(e){ aiBox.textContent = "Error: " + e; }
    finally { btn.disabled = false; }
  });
  pasteBtn.addEventListener('click', () => {
    const ta = document.querySelector('textarea');
    if(ta){ ta.value = (ta.value ? ta.value + "\n\n" : "") + lastAIText; ta.focus(); }
  });
})();
</script>
{% endblock %}
