{% extends 'base.html' %}

{% block content %}
<div class="card p-4 shadow-sm mb-4">
    <h3>{{ question.title }}</h3>
    <p class="text-muted">Asked by {{ question.author.username }} on {{ question.created_at }}</p>
    <p>{{ question.description }}</p>
</div>

{% if question.file %}
    <p><strong>Attached File:</strong> <a href="{{ question.file.url }}" target="_blank">Download</a></p>
{% endif %}

<hr>

<h5>Comments</h5>
{% for comment in question.comments.all %}
    <div class="border rounded p-2 mb-2">
        <strong>{{ comment.author.username }}</strong><br>
        {{ comment.content }}

        {% if comment.file %}
            <div class="mt-2">
                {% if comment.file.url|lower endswith ".jpg" or comment.file.url|lower endswith ".jpeg" or comment.file.url|lower endswith ".png" or comment.file.url|lower endswith ".gif" %}
                    <!-- Image preview -->
                    <a href="{{ comment.file.url }}" target="_blank">
                        <img src="{{ comment.file.url }}" alt="Attachment" style="max-width: 200px; height: auto; border-radius: 5px; border: 1px solid #ccc;">
                    </a>
                {% elif comment.file.url|lower endswith ".pdf" %}
                    <!-- PDF preview -->
                    <a href="{{ comment.file.url }}" target="_blank" class="btn btn-sm btn-info mt-1">View PDF</a>
                {% else %}
                    <!-- Other file -->
                    ðŸ“Ž <a href="{{ comment.file.url }}" target="_blank">Download Attachment</a>
                {% endif %}
            </div>
        {% endif %}

        <div class="text-muted small">{{ comment.created_at }}</div>

        {% if user.is_authenticated and (user == comment.author or user.is_superuser) %}
            <div class="mt-1">
                <a href="{% url 'edit_comment' comment.id %}" class="btn btn-sm btn-warning">Edit</a>
                <form action="{% url 'delete_comment' comment.id %}" method="post" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Delete this comment?');">Delete</button>
                </form>
                {% if comment.file %}
                    <a href="{{ comment.file.url }}" target="_blank" class="btn btn-sm btn-primary">View</a>
                {% endif %}
            </div>
        {% endif %}
    </div>
{% empty %}
    <p>No comments yet.</p>
{% endfor %}

{% if user.is_authenticated %}
    <!-- AI Suggestion Block -->
    <div class="p-3 bg-light border rounded mb-3">
        <h6><i class="bi bi-robot"></i> AI Suggestion</h6>
        <div id="ai-box" class="small text-muted">Click below to get AI suggestion</div>
        <button id="btn-ai" type="button" class="btn btn-outline-primary btn-sm mt-2">Get AI Answer</button>
        <button id="btn-ai-paste" type="button" class="btn btn-outline-success btn-sm mt-2" disabled>Paste into Comment</button>
    </div>

    <hr>
    <h6>Add a Comment</h6>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {{ comment_form.as_p }}
        <button type="submit" class="btn btn-success">Post Comment</button>
    </form>
{% else %}
    <p><a href="{% url 'login' %}">Login</a> to add a comment.</p>
{% endif %}

<script>
(function(){
  const aiBox = document.getElementById('ai-box');
  const btn = document.getElementById('btn-ai');
  const pasteBtn = document.getElementById('btn-ai-paste');
  if(!btn || !aiBox) return;
  let lastAIText = "";
  btn.addEventListener('click', async () => {
    aiBox.textContent = "Thinkingâ€¦";
    btn.disabled = true;
    pasteBtn.disabled = true;
    try {
      const res = await fetch("{% url 'ai_suggest' question.id %}");
      const data = await res.json();
      lastAIText = data.ai || "";
      aiBox.innerHTML = "<pre style='white-space:pre-wrap;'>" + lastAIText.replace(/</g,"&lt;") + "</pre>";
      pasteBtn.disabled = !lastAIText;
    } catch(e){ aiBox.textContent = "Error: " + e; }
    finally { btn.disabled = false; }
  });
  pasteBtn.addEventListener('click', () => {
    const ta = document.querySelector('textarea');
    if(ta){ ta.value = (ta.value ? ta.value + "\n\n" : "") + lastAIText; ta.focus(); }
  });
})();
</script>
{% endblock %}
